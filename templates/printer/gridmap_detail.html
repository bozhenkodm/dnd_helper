<!DOCTYPE html>
<html lang="en">
<style>
.container {
  position: relative;
  text-align: center;
  overflow-x: auto; /* Enable horizontal scrolling */
  white-space: nowrap; /* Prevent wrapping inside the container */
}

/* Rotation classes */
.rotate90 {
    transform: rotate(90deg);
}
.rotate180 {
    transform: rotate(180deg);
}
.rotate270 {
    transform: rotate(270deg);
}

/* Table styling */
table {
    {% if object.grid_color == 'none' %}
        border: none;
    {% else %}
        border-collapse: collapse;
        border: 1px solid {{ object.grid_color }};
    {% endif %}
    background-image: url({{ object.base_image.url }});
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    width: max-content; /* Ensure the table does not shrink */
    margin: 0; /* Remove auto-centering to respect horizontal scrolling */
}

/* Cell styling */
td {
    position: relative;
    isolation: isolate;
    text-align: center;
    color: {{ object.grid_color }};
    vertical-align: middle;
    border: 1px solid {{ object.grid_color }};
    width: {{ object.cell_size }}px;
    height: {{ object.cell_size }}px;
    aspect-ratio: 1 / 1;
}

/* Zone background styling */
.zone-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
    background-size: cover;
}

/* Participant image styling */
.participant-image {
    position: relative;
    z-index: 2;
    width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
}
</style>
<head>
    <meta charset="UTF-8">
    <title>{{ object }}</title>
</head>
<body>
<div class="container">
    <table>
        {% for row in object.grid_data %}
        <tr>
            {% for cell in row %}
            <td title="{{ cell.col }}, {{ cell.row }}{% if cell.participant %}; {{ cell.participant.1 }}{% endif %}"
                ondrop="drop(event)"
                ondragover="allowDrop(event)">

                {% if cell.zone %}
                <div class="zone-background"
                     style="background-image: url({{ cell.zone.image_url }}); opacity: {{ cell.zone.opacity }};">
                </div>
                {% endif %}

                {% if cell.participant %}
                <img id="{{ cell.participant.0 }}"
                     class="participant-image rotate{{ cell.participant.3 }}"
                     src="{{ cell.participant.2 }}"
                     draggable="true"
                     ondragstart="drag(event)"
                     style="opacity: {{ cell.participant.4 }}">
                {% endif %}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </table>
</div>
<script>
function allowDrop(event) {
    event.preventDefault();
}

function drag(event) {
    event.dataTransfer.setData("text", event.target.id);
}

function drop(event) {
    event.preventDefault();
    const data = event.dataTransfer.getData("text");
    const draggedElement = document.getElementById(data);

    // Get the target cell (td) even if we're dropping on an img
    const targetCell = event.target.closest('td');

    if (targetCell) {
        // Remove existing participant if present (client-side only)
        const existingImg = targetCell.querySelector('img');
        if (existingImg) existingImg.remove();

        // Move dragged element to new cell
        targetCell.appendChild(draggedElement);

        // Calculate new coordinates based on cell position
        const newRow = targetCell.parentNode.rowIndex + 1;
        const newCol = targetCell.cellIndex + 1;

        // Update participant's position on the server
        fetch('/printer/gridmap/{{ object.id }}/update-coords/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                participant_id: draggedElement.id,
                new_row: newRow,
                new_col: newCol
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Grid updated:', data);
            if (data.remnants) {
                console.log(data.remnants);
                location.reload();
            }
        })
        .catch(error => console.error('Error updating grid:', error));
    }
}
</script>
</body>
</html>